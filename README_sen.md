### Протокол взаимодействия на шине RS-485

## Теория

1. **Calculate Byte Transmission Time at 9600 Baud:**
    - Baud rate: 9600 bits per second (bps).
    - Each byte: 10 bits (8 data bits + 1 start bit + 1 stop bit).

    Time per byte = (10[bit] / 9600[bit/second]) = 0.00104167[sec] = 1041.67[us]

2. **Determine Packet Size and Transmission Time:**
    - Packet structure: 5 bytes for the header and footer + data payload.
    - Data payload size: 1 byte (CMD_SET_ID or CMD_DATA).

    Total packet size = 5[byte] + 1[byte] = 6[byte]
	Transmission time for one packet = 6[byte] * 1041.67[us] = 6250.02[us]
   
    - Two packets per time slot (one from master, one from slave):

	Total transmission time per time slot = 2 * 6250.02[us] = 12500.04[us]

3. **Calculate Slot Time for 64 Devices:**
    - Total time per sync cycle: 1 second (as per the existing setup).

	Slot time = 1000000[us] / 64 = 15625[us]
    
    Given that each slot should accommodate the time for two packets (one from master and one from slave), 
	15625 microseconds per slot is more than sufficient for the 12500.04 microseconds calculated.

#### Общая структура сообщений

Каждое сообщение состоит из следующих полей:
```
| Начало | Адрес | Команда | Данные | Контрольная сумма | Конец |
```
- **Начало**: Специальный байт для обозначения начала сообщения, например, `0x02`.
- **Адрес**: Адрес получателя сообщения (1 байт).
- **Команда**: Код команды (1 байт).
- **Данные**: Поле данных, длина зависит от команды.
- **Контрольная сумма**: Один байт, рассчитанный как XOR всех предыдущих байт сообщения.
- **Конец**: Специальный байт для обозначения конца сообщения, например, `0x03`.

### Команды протокола

#### 1. SYNC пакет

Используется для синхронизации таймеров слейвов и запуска передачи данных.

- **Команда**: `0x03`
- **Широковещательное сообщение**:
  ```
  | 0x02 | 0xFF | 0x03 | CS | 0x03 |
  ```

Процесс:
1. Мастер периодически отправляет SYNC пакет для синхронизации таймеров всех слейвов.
2. Слейвы получают SYNC пакет и запускают свои таймеры.

#### 2. Передача данных от слейва

Используется слейвами для передачи данных в отведенные им тайм-слоты.

- **Команда**: `0x82`
- **Сообщение от слейва**:
  ```
  | 0x02 | ID слейва | 0x82 | Данные | CS | 0x03 |
  ```

#### 3. Подтверждение или установка ID от мастера

Используется мастером для подтверждения получения данных или установки нового ID для неинициализированного слейва.

- **Команда подтверждения**: `0x04`
- **Команда установки ID**: `0x01`
- **Сообщение от мастера**:
  ```
  | 0x02 | ID слейва | 0x04 | CS | 0x03 |  (подтверждение)
  | 0x02 | 0x00 | 0x01 | Новый ID | CS | 0x03 |  (установка ID)
  ```

### Тайм-слоты

Каждому слейву выделяется свой тайм-слот для передачи данных, чтобы избежать коллизий на шине RS-485.

- **TimeSlotInterval**: Интервал времени, отведенный для одного слейва (например, 10 мс).
- **Тайм-слот слейва**: \(ID \times \text{TimeSlotInterval}\)

Процесс:
1. Слейвы синхронизируют свои таймеры при получении SYNC пакетов.
2. Каждый слейв передает данные только в свой тайм-слот.
3. Слейв с ID 0 передает данные в нулевом тайм-слоте и получает новый ID от мастера.
4. Тайм-слоты циклически повторяются каждые \(64 \times \text{TimeSlotInterval}\) миллисекунд.

### Порядок передачи данных

1. **Мастер отправляет SYNC пакет** каждые \(64 \times \text{TimeSlotInterval}\) миллисекунд.
2. **Слейвы синхронизируют свои таймеры** при получении SYNC пакета.
3. **Слейвы передают данные** в свои тайм-слоты:
   - Неинициализированный слейв (ID=0) передает данные в нулевом тайм-слоте.
   - Мастер отправляет команду установки нового ID или подтверждение получения данных.
   - Инициализированные слейвы передают данные в своих закрепленных тайм-слотах.
   - Мастер подтверждает получение данных.

### Пример последовательности

1. **Инициализация слейвов**:
   - Мастер отправляет SYNC пакет:
     ```
     | 0x02 | 0xFF | 0x03 | CS | 0x03 |
     ```
   - Неинициализированный слейв с ID 0 передает данные:
     ```
     | 0x02 | 0x00 | 0x82 | Данные | CS | 0x03 |
     ```
   - Мастер отправляет команду установки нового ID:
     ```
     | 0x02 | 0x00 | 0x01 | Новый ID | CS | 0x03 |
     ```

2. **Синхронизация и передача данных**:
   - Мастер отправляет SYNC пакет:
     ```
     | 0x02 | 0xFF | 0x03 | CS | 0x03 |
     ```
   - Слейвы синхронизируют свои таймеры и передают данные в свои тайм-слоты:
     ```
     | 0x02 | ID слейва | 0x82 | Данные | CS | 0x03 |
     ```
   - Мастер отправляет подтверждение получения данных:
     ```
     | 0x02 | ID слейва | 0x04 | CS | 0x03 |
     ```

### Преимущества и обработка возможных проблем

1. **Снижение коллизий**:
   - Тайм-слоты и синхронизация SYNC пакетами минимизируют возможность одновременной передачи данных.
2. **Эффективная инициализация**:
   - Использование адреса 0 для неинициализированных слейвов позволяет эффективно устанавливать новые ID.
3. **Периодическая синхронизация**:
   - Регулярные SYNC пакеты предотвращают накопление ошибок и рассогласование таймеров.
4. **Проверка успешности**:
   - Мастер подтверждает получение данных или устанавливает новый ID, обеспечивая надежность передачи данных.

Этот протокол обеспечивает стабильную и надежную работу системы с множеством слейвов, подключенных по шине RS-485, позволяя эффективно управлять передачей данных и предотвращать коллизии.
